---

# Run mysql_secure_installation if it was not run
- name: Check a flag that means mysql_secure_installation.yml was finished
  stat:
    path: /root/.keystone_database_was_initialized
  register: flag_file

- include: initialize_keystone_database.yml
  when: not flag_file.stat.exists

- name: Create a flag that means initialize_keystone_database.yml was finished
  copy:
    content: ""
    dest: /root/.keystone_database_was_initialized
    force: no
    owner: root
    group: root
    mode: '0640'

- name: Install packages of keystone
  apt:
    name:
      - keystone

- name: Initialize Fernet key repositories with keystone-manage fernet_setup
  ansible.builtin.command:
    argv:
      - keystone-manage
      - fernet_setup
      - --keystone-user
      - "{{ group_vars.keystone.user }}"
      - --keystone-group
      - "{{ group_vars.keystone.group }}"

- name: Initialize Fernet key repositories with keystone-manage credential_setup
  ansible.builtin.command:
    argv:
      - keystone-manage
      - credential_setup
      - --keystone-user
      - "{{ group_vars.keystone.user }}"
      - --keystone-group
      - "{{ group_vars.keystone.group }}"

